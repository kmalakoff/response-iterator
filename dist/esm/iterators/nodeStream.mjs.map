{"version":3,"file":"nodeStream.mjs","names":["hasIterator","Symbol","asyncIterator","nodeStreamIterator","stream","cleanup","error","done","data","waiting","onData","chunk","length","shift","value","push","onError","err","all","slice","forEach","pair","onEnd","undefined","removeListener","on","getNext","Promise","resolve","reject","iterator","next"],"sources":["../../../src/iterators/nodeStream.ts"],"sourcesContent":["import { Readable as NodeReadableStream } from \"stream\";\n\nconst hasIterator = typeof Symbol !== \"undefined\" && Symbol.asyncIterator;\n\n/* c8 ignore start */\nexport default function nodeStreamIterator<T>(stream: NodeReadableStream): AsyncIterableIterator<T> {\n  let cleanup = null;\n  let error = null;\n  let done = false;\n  const data = [];\n  const waiting = [];\n\n  function onData(chunk) {\n    if (error) return;\n    if (waiting.length) return waiting.shift()[0]({ value: chunk, done: false });\n    data.push(chunk);\n  }\n  function onError(err) {\n    error = err;\n    const all = waiting.slice();\n    all.forEach(function (pair) {\n      pair[1](err);\n    });\n    !cleanup || cleanup();\n  }\n  function onEnd() {\n    done = true;\n    const all = waiting.slice();\n    all.forEach(function (pair) {\n      pair[0]({ value: undefined, done: true });\n    });\n    !cleanup || cleanup();\n  }\n\n  cleanup = function () {\n    cleanup = null;\n    stream.removeListener(\"data\", onData);\n    stream.removeListener(\"error\", onError);\n    stream.removeListener(\"end\", onEnd);\n    stream.removeListener(\"finish\", onEnd);\n    stream.removeListener(\"close\", onEnd);\n  };\n  stream.on(\"data\", onData);\n  stream.on(\"error\", onError);\n  stream.on(\"end\", onEnd);\n  stream.on(\"finish\", onEnd);\n  stream.on(\"close\", onEnd);\n\n  function getNext(): Promise<IteratorResult<T, boolean>> {\n    return new Promise(function (resolve, reject) {\n      if (error) return reject(error);\n      if (data.length) return resolve({ value: data.shift(), done: false });\n      if (done) return resolve({ value: undefined, done: true });\n      waiting.push([resolve, reject]);\n    });\n  }\n\n  const iterator = {\n    next(): Promise<IteratorResult<T, boolean>> {\n      return getNext();\n    },\n  };\n\n  if (hasIterator) {\n    iterator[Symbol.asyncIterator] = function (): AsyncIterator<T> {\n      return this;\n    };\n  }\n\n  return iterator as AsyncIterableIterator<T>;\n}\n/* c8 ignore stop */\n"],"mappings":"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"}