{"version":3,"file":"response-iterator.js","sources":["../../src/iterators/async.ts","../../src/iterators/nodeStream.ts","../../src/iterators/promise.ts","../../src/iterators/reader.ts","../../src/index.ts"],"sourcesContent":["export default function asyncIterator<T>(source): AsyncIterableIterator<T> {\n  const iterator = source[Symbol.asyncIterator]();\n  return {\n    next(): Promise<IteratorResult<T, boolean>> {\n      return iterator.next();\n    },\n    [Symbol.asyncIterator](): AsyncIterator<T> {\n      return this;\n    },\n  } as AsyncIterableIterator<T>;\n}\n","import { Readable as NodeReadableStream } from \"stream\";\n\nconst hasIterator = typeof Symbol !== \"undefined\" && Symbol.asyncIterator;\n\n/* c8 ignore start */\nexport default function nodeStreamIterator<T>(stream: NodeReadableStream): AsyncIterableIterator<T> {\n  let cleanup = null;\n  let error = null;\n  let done = false;\n  const data = [];\n  const waiting = [];\n\n  function onData(chunk) {\n    if (error) return;\n    if (waiting.length) return waiting.shift()[0]({ value: chunk, done: false });\n    data.push(chunk);\n  }\n  function onError(err) {\n    error = err;\n    const all = waiting.slice();\n    all.forEach(function (pair) {\n      pair[1](err);\n    });\n    !cleanup || cleanup();\n  }\n  function onEnd() {\n    done = true;\n    const all = waiting.slice();\n    all.forEach(function (pair) {\n      pair[0]({ value: undefined, done: true });\n    });\n    !cleanup || cleanup();\n  }\n\n  cleanup = function () {\n    cleanup = null;\n    stream.removeListener(\"data\", onData);\n    stream.removeListener(\"error\", onError);\n    stream.removeListener(\"end\", onEnd);\n    stream.removeListener(\"finish\", onEnd);\n    stream.removeListener(\"close\", onEnd);\n  };\n  stream.on(\"data\", onData);\n  stream.on(\"error\", onError);\n  stream.on(\"end\", onEnd);\n  stream.on(\"finish\", onEnd);\n  stream.on(\"close\", onEnd);\n\n  function getNext(): Promise<IteratorResult<T, boolean>> {\n    return new Promise(function (resolve, reject) {\n      if (error) return reject(error);\n      if (data.length) return resolve({ value: data.shift(), done: false });\n      if (done) return resolve({ value: undefined, done: true });\n      waiting.push([resolve, reject]);\n    });\n  }\n\n  const iterator = {\n    next(): Promise<IteratorResult<T, boolean>> {\n      return getNext();\n    },\n  };\n\n  if (hasIterator) {\n    iterator[Symbol.asyncIterator] = function (): AsyncIterator<T> {\n      return this;\n    };\n  }\n\n  return iterator as AsyncIterableIterator<T>;\n}\n/* c8 ignore stop */\n","const hasIterator = typeof Symbol !== \"undefined\" && Symbol.asyncIterator;\n\n/* c8 ignore start */\nexport default function promiseIterator<T>(promise): AsyncIterableIterator<T> {\n  let resolved = false;\n\n  const iterator = {\n    next(): Promise<IteratorResult<T, boolean>> {\n      if (resolved) return Promise.resolve({ value: undefined, done: true });\n      resolved = true;\n      return new Promise(function (resolve, reject) {\n        promise\n          .then(function (value) {\n            resolve({ value, done: false });\n          })\n          .catch(reject);\n      });\n    },\n  };\n\n  if (hasIterator) {\n    iterator[Symbol.asyncIterator] = function (): AsyncIterator<T> {\n      return this;\n    };\n  }\n\n  return iterator as AsyncIterableIterator<T>;\n}\n/* c8 ignore stop */\n","const hasIterator = typeof Symbol !== \"undefined\" && Symbol.asyncIterator;\n\n/* c8 ignore start */\nexport default function readerIterator<T>(reader): AsyncIterableIterator<T> {\n  const iterator = {\n    next(): Promise<IteratorResult<T, boolean>> {\n      return reader.read();\n    },\n  };\n\n  if (hasIterator) {\n    iterator[Symbol.asyncIterator] = function (): AsyncIterator<T> {\n      return this;\n    };\n  }\n\n  return iterator as AsyncIterableIterator<T>;\n}\n/* c8 ignore stop */\n","import { AxiosResponse } from \"axios\";\nimport { Response as NodeResponse } from \"node-fetch\";\nimport { Readable as NodeReadableStream } from \"stream\";\n\nimport asyncIterator from \"./iterators/async\";\nimport nodeStreamIterator from \"./iterators/nodeStream\";\nimport promiseIterator from \"./iterators/promise\";\nimport readerIterator from \"./iterators/reader\";\n\ninterface CrossFetchResponse {\n  _bodyBlob: Blob;\n}\n\nconst hasIterator = typeof Symbol !== \"undefined\" && Symbol.asyncIterator;\n\n/**\n * @param response A response. Supports fetch, node-fetch, and cross-fetch\n */\nexport default function responseIterator<T>(response: unknown): AsyncIterableIterator<T> {\n  if (response === undefined) throw new Error(\"Missing response for responseIterator\");\n\n  // determine the body\n  let body: unknown = response;\n  if ((response as NodeResponse).body) body = (response as NodeResponse).body;\n  // node-fetch, browser fetch, undici\n  else if ((response as AxiosResponse).data) body = (response as AxiosResponse).data;\n  // axios\n  /* c8 ignore start */ else if ((response as CrossFetchResponse)._bodyBlob)\n    body = (response as CrossFetchResponse)._bodyBlob; // cross-fetch\n  /* c8 ignore stop */\n\n  // adapt the body\n  if (hasIterator && body[Symbol.asyncIterator]) return asyncIterator<T>(body as AsyncIterableIterator<T>);\n  /* c8 ignore start */\n  if ((body as ReadableStream<T>).getReader) return readerIterator<T>((body as ReadableStream<T>).getReader());\n  if ((body as Blob).stream)\n    return readerIterator<T>(((body as Blob).stream() as unknown as ReadableStream<T>).getReader());\n  if ((body as Blob).arrayBuffer) return promiseIterator<T>((body as Blob).arrayBuffer());\n  if ((body as NodeReadableStream).pipe) return nodeStreamIterator<T>(body as NodeReadableStream);\n  /* c8 ignore stop */\n\n  throw new Error(\"Unknown body type for responseIterator. Maybe you are not passing a streamable response\");\n}\n"],"names":["asyncIterator","source","iterator","Symbol","next","hasIterator","nodeStreamIterator","stream","cleanup","error","done","data","waiting","onData","chunk","length","shift","value","push","onError","err","all","slice","forEach","pair","onEnd","undefined","removeListener","on","getNext","Promise","resolve","reject","promiseIterator","promise","resolved","then","readerIterator","reader","read","responseIterator","response","Error","body","_bodyBlob","getReader","arrayBuffer","pipe"],"mappings":"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"}