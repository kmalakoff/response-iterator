{"version":3,"file":"response-iterator.js","sources":["../../src/iterators/async.ts","../../src/iterators/nodeStream.ts","../../src/iterators/promise.ts","../../src/iterators/reader.ts","../../src/index.ts"],"sourcesContent":["export default function asyncIterator<T>(source): AsyncIterableIterator<T> {\n  const iterator = source[Symbol.asyncIterator]();\n  return {\n    next(): Promise<IteratorResult<T, boolean>> {\n      return iterator.next();\n    },\n    [Symbol.asyncIterator](): AsyncIterator<T> {\n      return this;\n    },\n  } as AsyncIterableIterator<T>;\n}\n","import { Readable as NodeReadableStream } from \"stream\";\n\nconst hasIterator = typeof Symbol !== \"undefined\" && Symbol.asyncIterator;\n\n/* c8 ignore start */\nexport default function nodeStreamIterator<T>(stream: NodeReadableStream): AsyncIterableIterator<T> {\n  let cleanup = null;\n  let error = null;\n  let done = false;\n  const data = [];\n  const waiting = [];\n\n  function onData(chunk) {\n    if (error) return;\n    if (waiting.length) return waiting.shift()[0]({ value: chunk, done: false });\n    data.push(chunk);\n  }\n  function onError(err) {\n    error = err;\n    const all = waiting.slice();\n    all.forEach(function (pair) {\n      pair[1](err);\n    });\n    !cleanup || cleanup();\n  }\n  function onEnd() {\n    done = true;\n    const all = waiting.slice();\n    all.forEach(function (pair) {\n      pair[0]({ value: undefined, done: true });\n    });\n    !cleanup || cleanup();\n  }\n\n  cleanup = function () {\n    cleanup = null;\n    stream.removeListener(\"data\", onData);\n    stream.removeListener(\"error\", onError);\n    stream.removeListener(\"end\", onEnd);\n    stream.removeListener(\"finish\", onEnd);\n    stream.removeListener(\"close\", onEnd);\n  };\n  stream.on(\"data\", onData);\n  stream.on(\"error\", onError);\n  stream.on(\"end\", onEnd);\n  stream.on(\"finish\", onEnd);\n  stream.on(\"close\", onEnd);\n\n  function getNext(): Promise<IteratorResult<T, boolean>> {\n    return new Promise(function (resolve, reject) {\n      if (error) return reject(error);\n      if (data.length) return resolve({ value: data.shift(), done: false });\n      if (done) return resolve({ value: undefined, done: true });\n      waiting.push([resolve, reject]);\n    });\n  }\n\n  const iterator = {\n    next(): Promise<IteratorResult<T, boolean>> {\n      return getNext();\n    },\n  };\n\n  if (hasIterator) {\n    iterator[Symbol.asyncIterator] = function (): AsyncIterator<T> {\n      return this;\n    };\n  }\n\n  return iterator as AsyncIterableIterator<T>;\n}\n/* c8 ignore stop */\n","const hasIterator = typeof Symbol !== \"undefined\" && Symbol.asyncIterator;\n\n/* c8 ignore start */\nexport default function promiseIterator<T>(promise): AsyncIterableIterator<T> {\n  let resolved = false;\n\n  const iterator = {\n    next(): Promise<IteratorResult<T, boolean>> {\n      if (resolved) return Promise.resolve({ value: undefined, done: true });\n      resolved = true;\n      return new Promise(function (resolve, reject) {\n        promise\n          .then(function (value) {\n            resolve({ value, done: false });\n          })\n          .catch(reject);\n      });\n    },\n  };\n\n  if (hasIterator) {\n    iterator[Symbol.asyncIterator] = function (): AsyncIterator<T> {\n      return this;\n    };\n  }\n\n  return iterator as AsyncIterableIterator<T>;\n}\n/* c8 ignore stop */\n","const hasIterator = typeof Symbol !== \"undefined\" && Symbol.asyncIterator;\n\n/* c8 ignore start */\nexport default function readerIterator<T>(reader): AsyncIterableIterator<T> {\n  const iterator = {\n    next(): Promise<IteratorResult<T, boolean>> {\n      return reader.read();\n    },\n  };\n\n  if (hasIterator) {\n    iterator[Symbol.asyncIterator] = function (): AsyncIterator<T> {\n      return this;\n    };\n  }\n\n  return iterator as AsyncIterableIterator<T>;\n}\n/* c8 ignore stop */\n","import { AxiosResponse } from \"axios\";\nimport { Response as NodeResponse } from \"node-fetch\";\nimport { Readable as NodeReadableStream } from \"stream\";\n\nimport asyncIterator from \"./iterators/async\";\nimport nodeStreamIterator from \"./iterators/nodeStream\";\nimport promiseIterator from \"./iterators/promise\";\nimport readerIterator from \"./iterators/reader\";\n\ninterface CrossFetchResponse {\n  _bodyBlob: Blob;\n}\n\nconst hasIterator = typeof Symbol !== \"undefined\" && Symbol.asyncIterator;\n\n/**\n * @param response A response. Supports fetch, node-fetch, and cross-fetch\n */\nexport default function responseIterator<T>(response: unknown): AsyncIterableIterator<T> {\n  if (response === undefined) throw new Error(\"Missing response for responseIterator\");\n\n  // determine the body\n  let body: unknown = response;\n  if ((response as NodeResponse).body) body = (response as NodeResponse).body;\n  // node-fetch, browser fetch, undici\n  else if ((response as AxiosResponse).data) body = (response as AxiosResponse).data;\n  // axios\n  /* c8 ignore start */ else if ((response as CrossFetchResponse)._bodyBlob)\n    body = (response as CrossFetchResponse)._bodyBlob; // cross-fetch\n  /* c8 ignore stop */\n\n  // adapt the body\n  if (hasIterator && body[Symbol.asyncIterator]) return asyncIterator<T>(body as AsyncIterableIterator<T>);\n  /* c8 ignore start */\n  if ((body as ReadableStream<T>).getReader) return readerIterator<T>((body as ReadableStream<T>).getReader());\n  if ((body as Blob).stream)\n    return readerIterator<T>(((body as Blob).stream() as unknown as ReadableStream<T>).getReader());\n  if ((body as Blob).arrayBuffer) return promiseIterator<T>((body as Blob).arrayBuffer());\n  if ((body as NodeReadableStream).pipe) return nodeStreamIterator<T>(body as NodeReadableStream);\n  /* c8 ignore stop */\n\n  throw new Error(\"Unknown body type for responseIterator. Maybe you are not passing a streamable response\");\n}\n"],"names":["asyncIterator","source","iterator","Symbol","next","hasIterator","nodeStreamIterator","stream","cleanup","error","done","data","waiting","onData","chunk","length","shift","value","push","onError","err","all","slice","forEach","pair","onEnd","undefined","removeListener","on","getNext","Promise","resolve","reject","promiseIterator","promise","resolved","then","readerIterator","reader","read","responseIterator","response","Error","body","_bodyBlob","getReader","arrayBuffer","pipe"],"mappings":"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"}